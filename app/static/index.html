<!doctype html><meta charset="utf-8"/>
<title>Store Assistant - AI Chat</title>
<style>
body{font-family:sans-serif;max-width:800px;margin:20px auto;background:#f5f5f5}
.chat-container{background:white;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.1);overflow:hidden}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;text-align:center}
.header h1{margin:0;font-size:24px}
.header p{margin:5px 0 0;opacity:0.9;font-size:14px}
#log{height:400px;overflow-y:auto;padding:20px;background:#fafafa}
.message{margin-bottom:15px;display:flex;align-items:flex-start}
.user{justify-content:flex-end}.user .bubble{background:#667eea;color:white;margin-left:50px}
.bot{justify-content:flex-start}.bot .bubble{background:white;border:1px solid #e0e0e0;margin-right:50px}
.bubble{max-width:70%;padding:12px 16px;border-radius:18px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.bot-info{font-size:11px;color:#666;margin-top:5px;display:flex;justify-content:space-between}
.sources{font-size:10px;color:#888;margin-top:3px}
.confidence{font-size:10px;color:#888}
.confidence.high{color:#4CAF50} .confidence.medium{color:#FF9800} .confidence.low{color:#f44336}
.input-area{padding:20px;background:white;border-top:1px solid #e0e0e0;display:flex;gap:10px}
#i{flex:1;padding:12px;border:1px solid #ddd;border-radius:25px;outline:none}
#send{padding:12px 24px;background:#667eea;color:white;border:none;border-radius:25px;cursor:pointer}
#send:hover{background:#5a6fd8}
.suggestions{padding:15px 20px;background:#f8f9ff;border-top:1px solid #e0e0e0}
.suggestions h4{margin:0 0 10px;color:#333;font-size:14px}
.suggestion-btn{display:inline-block;margin:3px;padding:6px 12px;background:white;border:1px solid #ddd;border-radius:15px;cursor:pointer;font-size:12px;color:#555}
.suggestion-btn:hover{background:#667eea;color:white}
.typing{opacity:0.7;font-style:italic}
.lang-indicator{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;font-size:12px}
</style>

<div class="chat-container">
  <div class="header">
    <h1>üè™ Store Assistant</h1>
    <p>AI-powered customer service ‚Ä¢ Ask anything about our store!</p>
    <div class="lang-indicator" id="langIndicator">EN</div>
  </div>
  
  <div id="log"></div>
  
  <div class="suggestions" id="suggestions">
    <h4>üí° Suggested Questions:</h4>
    <div id="suggestionBtns"></div>
  </div>
  
  <div class="input-area">
    <input id="i" placeholder="Type your question..." />
    <button id="send">Send</button>
  </div>
</div>

<script>
const log = document.getElementById('log');
const input = document.getElementById('i');
const sendBtn = document.getElementById('send');
const suggestions = document.getElementById('suggestions');
const suggestionBtns = document.getElementById('suggestionBtns');
const langIndicator = document.getElementById('langIndicator');

let sessionId = localStorage.getItem('sessionId') || null;
let currentLanguage = 'en';

function addMessage(role, text, metadata = {}) {
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${role}`;
  
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  
  if (role === 'user') {
    bubble.textContent = text;
  } else {
    bubble.innerHTML = text;
    
    // Add bot metadata
    if (metadata.confidence !== undefined || metadata.sources) {
      const infoDiv = document.createElement('div');
      infoDiv.className = 'bot-info';
      
      let infoHtml = '';
      
      if (metadata.confidence !== undefined) {
        const conf = metadata.confidence;
        const confClass = conf > 0.7 ? 'high' : conf > 0.4 ? 'medium' : 'low';
        infoHtml += `<span class="confidence ${confClass}">Confidence: ${(conf * 100).toFixed(0)}%</span>`;
      }
      
      if (metadata.sources && metadata.sources.length > 0) {
        const sourceText = metadata.sources.slice(0, 2).join(', ');
        infoHtml += `<span class="sources">Sources: ${sourceText}</span>`;
      }
      
      infoDiv.innerHTML = infoHtml;
      bubble.appendChild(infoDiv);
    }
  }
  
  msgDiv.appendChild(bubble);
  log.appendChild(msgDiv);
  log.scrollTop = log.scrollHeight;
}

function showTyping() {
  const typing = document.createElement('div');
  typing.className = 'message bot typing';
  typing.innerHTML = '<div class="bubble">Thinking...</div>';
  typing.id = 'typing';
  log.appendChild(typing);
  log.scrollTop = log.scrollHeight;
}

function hideTyping() {
  const typing = document.getElementById('typing');
  if (typing) typing.remove();
}

function updateSuggestions(suggestionList) {
  if (!suggestionList || suggestionList.length === 0) {
    suggestions.style.display = 'none';
    return;
  }
  
  suggestions.style.display = 'block';
  suggestionBtns.innerHTML = '';
  
  suggestionList.forEach(suggestion => {
    const btn = document.createElement('span');
    btn.className = 'suggestion-btn';
    btn.textContent = suggestion;
    btn.onclick = () => {
      input.value = suggestion;
      sendMessage();
    };
    suggestionBtns.appendChild(btn);
  });
}

function updateLanguage(lang) {
  currentLanguage = lang;
  langIndicator.textContent = lang.toUpperCase();
  
  // Update placeholder text
  if (lang === 'ar') {
    input.placeholder = 'ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß...';
    input.style.direction = 'rtl';
  } else {
    input.placeholder = 'Type your question...';
    input.style.direction = 'ltr';
  }
}

async function sendMessage() {
  const text = input.value.trim();
  if (!text) return;
  
  addMessage('user', text);
  input.value = '';
  showTyping();
  
  try {
    const response = await fetch('/channels/webchat/message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        session_id: sessionId,
        locale: currentLanguage === 'auto' ? null : currentLanguage
      })
    });
    
    const result = await response.json();
    hideTyping();
    
    if (result.session_id) {
      sessionId = result.session_id;
      localStorage.setItem('sessionId', sessionId);
    }
    
    // Update language if detected
    if (result.language) {
      updateLanguage(result.language);
    }
    
    // Add bot response
    addMessage('bot', result.text || 'Sorry, I couldn\'t understand that.', {
      confidence: result.confidence,
      sources: result.sources
    });
    
    // Update suggestions (only show for new conversations)
    if (result.suggested_questions) {
      updateSuggestions(result.suggested_questions);
    }
    
  } catch (error) {
    hideTyping();
    addMessage('bot', 'Sorry, I\'m having technical difficulties. Please try again.');
    console.error('Chat error:', error);
  }
}

// Event listeners
sendBtn.onclick = sendMessage;
input.onkeypress = (e) => {
  if (e.key === 'Enter') sendMessage();
};

// Load initial suggestions
async function loadInitialSuggestions() {
  try {
    const response = await fetch('/channels/webchat/suggestions');
    const data = await response.json();
    updateSuggestions(data.suggestions);
  } catch (error) {
    console.error('Failed to load suggestions:', error);
  }
}

// Initialize
addMessage('bot', 'Hello! I\'m your AI store assistant. How can I help you today?');
loadInitialSuggestions();
</script>